name: Build and Deploy Qt EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Debug workspace
      shell: pwsh
      run: |
        Write-Host "üîç Current directory:"
        Get-Location

        Write-Host "üì¶ All files in workspace:"
        Get-ChildItem -Recurse -Force | Select-Object FullName

    - name: Install Qt (MinGW)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.8.3'
        arch: 'win64_mingw'

    - name: Add Qt bin directory to PATH
      run: echo "C:\Qt\6.8.3\mingw_64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh

    - name: Build test_0.pro using qmake + mingw32-make
      shell: pwsh
      run: |
        cd Packet_Versions/Packet1
        qmake test_0.pro CONFIG-=no_main CONFIG+=console
        mingw32-make

    - name: Find and deploy EXE with windeployqt
      shell: pwsh
      run: |
        $exe = Get-ChildItem -Path . -Recurse -Filter *.exe | Where-Object { $_.FullName -notmatch '\\windeployqt\\' } | Select-Object -First 1

        if (-not $exe) {
          Write-Error "‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£Ÿä ŸÖŸÑŸÅ .exe" ; exit 1
        }

        Write-Host "‚úÖ Found EXE: $($exe.FullName)"

        $deployTool = "C:\Qt\6.8.3\mingw_64\bin\windeployqt.exe"

        if (-Not (Test-Path $deployTool)) {
          Write-Error "‚ùå windeployqt.exe not found at $deployTool" ; exit 1
        }

        & "$deployTool" "$($exe.FullName)"

    - name: Upload built files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployed-exe-with-dlls
        path: |
          **/*.exe
          **/*.dll
