name: Build and Deploy Qt 6.8.3 EXE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v3

      # 2) Install aqtinstall
      - name: Install aqtinstall
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install aqtinstall

      # 3) Download Qt 6.8.3 via aqtinstall & add bin to PATH
      - name: Download Qt 6.8.3 and locate windeployqt
        shell: pwsh
        run: |
          # Ù†Ù†Ø²Ù„ Qt 6.8.3 Ù…Ø¹ MinGW
          aqt install-qt windows desktop 6.8.3 win64_mingw --outputdir Qt
          
          $qtRoot = "${{ github.workspace }}\Qt\6.8.3"
          Write-Host "ğŸ” Scanning $qtRoot for a spec folder containing bin\windeployqt.exe"
          
          # Ù†Ø¹Ø«Ø± Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ù…Ø¬Ù„Ø¯ ÙØ±Ø¹ÙŠ ÙŠØ­ÙˆÙŠ windeployqt.exe
          $spec = Get-ChildItem -Path $qtRoot -Directory |
                  Where-Object { Test-Path (Join-Path $_.FullName 'bin\windeployqt.exe') } |
                  Select-Object -First 1

          if (-not $spec) {
            Write-Error "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ windeployqt.exe ØªØ­Øª $qtRoot"
            exit 1
          }
          $qtBin = Join-Path $spec.FullName 'bin'
          Write-Host "âœ… Found Qt 6.8.3 bin at: $qtBin"
          
          # Ù†Ø¶ÙŠÙ Qt bin Ø¥Ù„Ù‰ PATH
          "$qtBin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      # 4) Build the project
      - name: Build test_0.pro
        shell: pwsh
        run: |
          cd Packet_Versions/Packet1
          qmake test_0.pro CONFIG-=no_main CONFIG+=console
          mingw32-make

      # 5) Find generated EXE and its directory
      - name: Find generated .exe
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path Packet_Versions/Packet1 -Recurse -Filter *.exe |
                 Where-Object { $_.DirectoryName -match 'Desktop_Qt_6.8.3' } |
                 Select-Object -First 1

          if (-not $exe) {
            Write-Error "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ù„Ù .exe Ù…Ù† build Qt 6.8.3"
            exit 1
          }
          $exePath = $exe.FullName
          $exeDir  = Split-Path $exePath -Parent
          Write-Host "âœ… Found EXE at: $exePath"
          "EXE_PATH=$exePath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "EXE_DIR=$exeDir"   | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      # 6) Deploy Qt dependencies
      - name: Deploy Qt dependencies with windeployqt
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Deploying dependencies for $env:EXE_PATH"
          Push-Location $env:EXE_DIR
          windeployqt (Split-Path $env:EXE_PATH -Leaf)
          Pop-Location

      # 7) Upload all files under EXE_DIR (includes .exe, .dll, pluginsâ€¦)
      - name: Upload deployed files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployed-exe-with-dlls
          path: ${{ env.EXE_DIR }}/**/*
